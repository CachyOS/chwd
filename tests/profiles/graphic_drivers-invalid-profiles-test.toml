[nvidia-dkms.40xxcards]
desc = 'Closed source NVIDIA drivers(40xx series) for Linux (Latest)'
priority = 9
packages = 'nvidia-utils egl-wayland nvidia-settings opencl-nvidia lib32-opencl-nvidia lib32-nvidia-utils libva-nvidia-driver vulkan-icd-loader lib32-vulkan-icd-loader'
conditional_packages = """
    kernels="$(pacman -Qqs "^linux-cachyos")"
    modules=""

    for kernel in $kernels; do
        case "$kernel" in
            *-headers|*-zfs);;
            *-nvidia) modules+=" ${kernel}";;
            *) modules+=" ${kernel}-nvidia";;
        esac
    done

    # Fallback if there are no kernels with pre-built modules
    [ -z "$modules" ] && modules="nvidia-dkms"

    echo "$modules"
"""
post_install = """
    cat <<EOF >/etc/mkinitcpio.conf.d/10-chwd.conf
# This file is automatically generated by chwd. PLEASE DO NOT EDIT IT.
MODULES+=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)
EOF
    mkinitcpio -P
"""
post_remove = """
    rm -f /etc/mkinitcpio.conf.d/10-chwd.conf
    mkinitcpio -P
"""
device_ids = '*'

[nvidia-dkms]
desc = 'Closed source NVIDIA drivers for Linux (Latest)'
nonfree = true
class_ids = "0300 0380 0302"
vendor_ids = "10de"
priority = 8
packages = 'nvidia-utils egl-wayland nvidia-settings opencl-nvidia lib32-opencl-nvidia lib32-nvidia-utils libva-nvidia-driver vulkan-icd-loader lib32-vulkan-icd-loader'
conditional_packages = """
    kernels="$(pacman -Qqs "^linux-cachyos")"
    modules=""

    for kernel in $kernels; do
        case "$kernel" in
            *-headers|*-zfs);;
            *-nvidia) modules+=" ${kernel}";;
            *) modules+=" ${kernel}-nvidia";;
        esac
    done

    # Fallback if there are no kernels with pre-built modules
    [ -z "$modules" ] && modules="nvidia-dkms"

    echo "$modules"
"""
post_install = """
    cat <<EOF >/etc/mkinitcpio.conf.d/10-chwd.conf
# This file is automatically generated by chwd. PLEASE DO NOT EDIT IT.
MODULES+=(nvidia nvidia_modeset nvidia_uvm nvidia_drm)
EOF
    mkinitcpio -P
"""
post_remove = """
    rm -f /etc/mkinitcpio.conf.d/10-chwd.conf
    mkinitcpio -P
"""
device_ids = '>/some/path/to/file/nvidia-invalid-ids.ids'

[invalid]
desc = "Invalid profile for testing only"
