# MacBook T2

[macbook-t2]
desc = 'Packages and device configuration for the T2 Macbook'
priority = 9
class_ids = "0000"
vendor_ids = "106b"
device_ids = "1801 1802"
packages = 'apple-t2-audio-config t2fanrd'
post_install = """
    cat <<EOF >/etc/mkinitcpio.conf.d/11-chwd.conf
# This file is automatically generated by chwd. PLEASE DO NOT EDIT IT.
MODULES+=(apple-bce)
EOF
    mkinitcpio -P

    echo apple-bce > /etc/modules-load.d/t2.conf
    kernelparams="intel_iommu=on iommu=pt pcie_ports=compat"
    echo "Adding required kernel parameters..."

    if [ -f /etc/sdboot-manage.conf ]; then
        sed -i "s/LINUX_OPTIONS=\"[^\"]*/& ${kernelparams}/" /etc/sdboot-manage.conf
    fi

    if pacman -Qs grub &> /dev/null ; then
        echo "GRUB is installed. Generating the GRUB configuration file..."
        sed -i "s/GRUB_CMDLINE_LINUX_DEFAULT=\"[^\"]*/& ${kernelparams}/" /etc/default/grub
        grub-mkconfig -o /boot/grub/grub.cfg
    fi
    
    cat <<EOF >/etc/modprobe.d/brcmfmac.conf
# This file is automatically generated by chwd. PLEASE DO NOT EDIT IT.
options brcmfmac feature_disable=0x82000
EOF

    cat <<EOF | sudo tee /etc/udev/rules.d/99-network-t2-ncm.rules
# This file is automatically generated by chwd. PLEASE DO NOT EDIT IT.
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="ac:de:48:00:11:22", NAME="t2_ncm"
EOF

    cat <<EOF | sudo tee /etc/NetworkManager/conf.d/99-network-t2-ncm.conf
# This file is automatically generated by chwd. PLEASE DO NOT EDIT IT.
[main]
no-auto-default=t2_ncm
EOF

"""
post_remove = """
    rm -f /etc/mkinitcpio.conf.d/11-chwd.conf
    rm -f /etc/modprobe.d/brcmfmac.conf
    rm -f /etc/modules-load.d/t2.conf

    mkinitcpio -P
    kernelparams="intel_iommu=on iommu=pt pcie_ports=compat"
    echo "Removing kernel parameters..."
    if [ -f /etc/sdboot-manage.conf ]; then
        sed -i "s/${kernelparams}//" /etc/sdboot-manage.conf
    fi
    if pacman -Qs grub &> /dev/null ; then
        sed -i "s/${kernelparams}//" /etc/default/grub
    fi
"""
