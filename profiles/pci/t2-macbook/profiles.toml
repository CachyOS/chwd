# MacBook T2

[macbook-t2]
desc = 'Packages and device configuration for the T2 Macbook'
priority = 9
class_ids = "0000"
vendor_ids = "106b"
device_ids = "1801 1802"
packages = 'apple-t2-audio-config tiny-dfr t2fandrd'
post_install = """
    cat <<EOF >/etc/mkinitcpio.conf.d/10-chwd.conf
# This file is automatically generated by chwd. PLEASE DO NOT EDIT IT.
MODULES+=(apple-bce)
EOF
    mkinitcpio -P

    echo apple-bce | tee /etc/modules-load.d/t2.conf
    kernelparams="intel_iommu=on iommu=pt pcie_ports=compat"
    echo "Adding required kernel parameters..."

    if [ -f /etc/sdboot-manage.conf ]; then
        sed -i "s/LINUX_OPTIONS=\"[^\"]*/& ${kernelparams}/" /etc/sdboot-manage.conf
    fi

    if pacman -Qs grub &> /dev/null
    then
        echo "GRUB is installed. Generating the GRUB configuration file..."
        sed -i "s/GRUB_CMDLINE_LINUX_DEFAULT=\"[^\"]*/& ${kernelparams}/" /etc/defaut/grub
        grub-mkconfig -o /boot/grub/grub.cfg
    fi
    
    
"""
post_remove = """
    rm -f /etc/mkinitcpio.conf.d/10-chwd.conf
    mkinitcpio -P
    rm -rf /etc/modules-load.d/t2.conf
    kernelparams="intel_iommu=on iommu=pt pcie_ports=compat"
    echo "Removing kernel parameters..."
    if [ -f /etc/sdboot-manage.conf ]; then
    sed -i "s/${kernelparams}//" /etc/sdboot-manage.conf
    fi
    if pacman -Qs grub &> /dev/null
    then
        sed -i "s/${kernelparams}//" /etc/default/grub
    fi
"""
